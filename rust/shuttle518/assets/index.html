<!DOCTYPE html>
<html lang="zh_cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <main>
        <section>
            <form id="fund">
                <input id="code" name="code" type="text" placeholder="code" required>
                <input id="buy_date" name="buy_date" type="date" placeholder="buy_date" required>
                <input id="price" name="price" type="number" placeholder="price" required>
                <input id="amount" name="amount" type="number" placeholder="amount" required>
                <input id="tranche" name="tranche" type="number" placeholder="tranche" required>
                <button id="save-fund" type="button">保存</button>
                <input id="id" name="id" type="text" placeholder="id" required>
                <button id="update-fund" type="button">更新</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>金额</th>
                        <th>日期</th>
                        <th>总收益</th>
                        <th>万份收益</th>
                        <th>年化收益</th>
                    </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </section>
        <section>
            <form>
                <input id="content" name="content" type="text" placeholder="content" required>
                <input id="remark" name="remark" type="text" placeholder="remark" required>
                <button id="save" type="button">保存</button>
            </form>
            <ul></ul>
        </section>
    </main>
    <script>
        ;(function(){
            document.querySelector("#save-fund").addEventListener('click',function(){
                addOrUpdateFund({
                    code:window.code.value,
                    buy_date:window.buy_date.value,
                    price:+window.price.value,
                    amount:+window.amount.value,
                    tranche:+window.tranche.value
                })
            },false)
            document.querySelector('#update-fund').addEventListener('click',function(){
                addOrUpdateFund({
                    id:+window.id.value,
                    code:window.code.value,
                    buy_date:window.buy_date.value,
                    price:+window.price.value,
                    amount:+window.amount.value,
                    tranche:+window.tranche.value
                })
            },false)
            document.querySelector('#save').addEventListener('click',function(){
                const content = document.querySelector("#content").value
                const remark = document.querySelector("#remark").value
                addUrl({
                    content,
                    remark
                })
            },false)
            getUrls()
            getFunds()
            async function getUrls(){
                const res = await fetch('/api/getUrls')
                const data = await res.json()
                let html = ''
                document.querySelector('ul').innerHTML = ''
                data.forEach(item=>{
                    html += `<li>${item.content} <span>${item.remark}</span></li>`
                })
                document.querySelector('ul').insertAdjacentHTML('beforeend',html)
            }
            async function addUrl(data){
                await fetch('api/addUrl',{
                    method: 'POST',
                    headers: {
                      "Content-Type": "application/json",
                      // 'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: JSON.stringify(data)
                })
                getUrls()
            }
            async function getFunds(){
                const res = await fetch('/api/getFunds')
                const data = await res.json()
                let html = ''
                document.querySelector('tbody').insertAdjacentHTML('beforeend',html)
                data.forEach(item=>{
                    html += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.amount}</td>
                            <td>${item.buy_date}</td>
                            <td>${item.total}</td>
                            <td>${item.unit}</td>
                            <td>${item.year}</td>
                        </tr>
                    `
                })
                document.querySelector('tbody').insertAdjacentHTML('beforeend',html)
            }
            async function addOrUpdateFund(data){
                await fetch(data.id?'api/updateFund':'api/addFund',{
                    method: 'POST',
                    headers: {
                      "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                })
                getFunds()
            }
        })()
    </script>
</body>
</html>